<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>工作台</title>
    <link rel="stylesheet" href="../../static/style/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="../../static/style/bootstrap/bootstrap-table.min.css">
    <link rel="stylesheet" href="../../static/style/bootstrap/bootstrap-select.min.css">
    <link rel="stylesheet" href="../../static/style/bootstrap/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="../../static/style/font-awesome.min.css">
    <link rel="stylesheet" href="../../static/style/base.css">
    <script src="../../static/script/jquery-3.3.1.min.js"></script>
    <script src="../../static/highcharts/highstock.js"></script>
    <script src="../../static/highcharts/highcharts-zh_CN.js"></script>
    <script src="../../static/script/bootstrap/bootstrap.min.js"></script>
    <script src="../../static/script/bootstrap/bootstrap-table.min.js"></script>
    <script src="../../static/script/bootstrap/bootstrap-table-zh-CN.min.js"></script>
    <script src="../../static/script/bootstrap/bootstrap-select.min.js"></script>
    <script src="../../static/script/bootstrap/bootstrap-datetimepicker.min.js"></script>
    <script src="../../static/script/bootstrap/bootbox.min.js"></script>
    <script src="../../static/script/jquery.select.js"></script>
    <script src="../../static/script/base.js"></script>
    <script src="../../static/script/bootstrapTableCommon.js"></script>
</head>
<body>
    <div class="col-md-12" style="padding:32px 0 0;">
        <div class="col-md-8">
            <div class="mics-panel-head">
                <div class="mics-panel-title pull-left">能耗趋势</div>
                <div class="mics-form-select EnergyChartSelect_Time pull-right">
                    <select name="" class="select selectFontKeepLeft" id="EnergyChartSelect_Time">
                        <option value="日">日</option>
                        <option value="月">月</option>
                        <option value="年">年</option>
                    </select>
                </div>
                <div class="mics-form-select EnergyChartSelect_Item pull-right">
                    <select name="" class="select selectFontKeepLeft" id="EnergyChartSelect_Item">
                        <option value="电">电</option>
                        <option value="水">水</option>
                        <option value="汽">汽</option>
                    </select>
                </div>
            </div>
            <div id="highchartsEnergy" style="min-width:400px;height:295px;margin-top: 15px;"></div>
        </div>
        <div class="col-md-4">
            <div class="mics-panel-head">
                <div class="mics-panel-title pull-left">分项能耗趋势</div>
                <div class="mics-form-select pull-right"></div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="trendsChartContent dragscroll">
                        <div class="trendsChartItem mics-bg-primary" data-Energy="电">
                            <div class="form-group">电能</div>
                            <div class="form-group"><span id="EtotalZGL">0</span></div>
                            <div class="form-group"><div class="row"><div class="highcharts-item" id="highcharts-electricity" style="min-width:162px;height:74px"></div></div></div>
                            <div class="form-group totalData"></div>
                        </div>
                        <div class="trendsChartItem mics-bg-primary" data-Energy="水">
                            <div class="form-group">水能</div>
                            <div class="form-group" id="WtotalF">0</div>
                            <div class="form-group"><div class="row"><div class="highcharts-item" id="highcharts-water" style="min-width:162px;height:74px"></div></div></div>
                            <div class="form-group totalData"><span id="WtotalS">0</span></div>
                        </div>
                        <div class="trendsChartItem mics-bg-primary" data-Energy="汽">
                            <div class="form-group">汽能</div>
                            <div class="form-group" id="StotalF">0</div>
                            <div class="form-group"><div class="row"><div class="highcharts-item" id="highcharts-steam" style="min-width:162px;height:74px"></div></div></div>
                            <div class="form-group totalData"><span id="StotalS">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-12" style="padding:32px 0 0;height: 425px;">
        <div class="col-md-5">
            <div class="mics-panel-head">
                <div class="mics-form-select EnergyAreaSelect pull-left">
                    <select name="" class="select" id="EnergyAreaSelect"></select>
                </div>
                <div class="mics-form-select EnergyAreaDateSelect pull-right">
                    <select name="" class="select selectFontKeepLeft" id="EnergyAreaDateSelect">
                        <option value="日">日</option>
                        <option value="月">月</option>
                        <option value="年">年</option>
                    </select>
                </div>
            </div>
            <div class="EnergyAreaTable">
                <table>
                    <tbody>
                        <tr>
                            <td style="width: 42px;"><div class="fontBlock"><span class="fa fa-flash"></span></div></td>
                            <td class="text-left">电能耗量</td>
                            <td><span id="ElectricValue">0</span></td>
                        </tr>
                        <tr>
                            <td><div class="fontBlock"><span class="fa fa-tint"></span></div></td>
                            <td class="text-left">水能耗量</td>
                            <td><span id="WaterValue">0</span></td>
                        </tr>
                        <tr>
                            <td><div class="fontBlock"><span class="fa fa-tachometer"></span></div></td>
                            <td class="text-left">汽能耗量</td>
                            <td><span id="SteamValue">0</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-3">
            <div class="mics-panel-head">
                <div class="mics-panel-title pull-left">成本展示</div>
                <div class="mics-form-select EnergyClassSelect pull-right">
                    <select name="" class="select selectFontKeepLeft" id="EnergyClassSelect">
                        <option value="日">日</option>
                        <option value="月">月</option>
                        <option value="年">年</option>
                    </select>
                </div>
            </div>
            <div class="col-md-12">
                <div class="costHead mics-bg-primary">
                    <span class="pull-left" id="costData">16452.17</span>
                    <span class="pull-right">RMB</span>
                </div>
                <div class="costPieChart mics-bg-primary">

                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="mics-panel-head">
                <div class="mics-panel-title pull-left">区域数据在线采集</div>
                <div class="mics-panel-title pull-right">All</div>
            </div>
            <div class="areaCollect">
                <table id="areaCollectTable"></table>
            </div>
        </div>
    </div>
    <div id="realTimeModal" class="modal mics-modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">实时数据</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="EnergyInd" value="">
                    <div class="col-md-12">
                        <div class="col-md-7">
                            <form class="form-inline">
                                <div class="form-group">
                                    <div class="input-group">
                                        <input type="text" class="form-control datetimepicker" id="startTime" readonly>
                                    </div>
                                    <div class="input-group">
                                        <input type="text" class="form-control datetimepicker" id="endTime" readonly>
                                    </div>
                                </div>
                            </form>
                            <div id="modalEnergyHistoryChart" style="width: 100%;height: 410px;margin-top: 20px;"></div>
                            <div class="mics-panel-head">
                                <div class="mics-panel-title pull-left">累计能耗量:</div>
                            </div>
                            <div class="mics-panel-head">
                                <label for="" class="groupLabel" id="EnergyHistoryDataTotal">0</label>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="mics-panel-head">
                                <div class="mics-panel-title pull-left">区域能耗排名:</div>
                            </div>
                            <div id="rankingChart" style="width: 100%;margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" class="close" data-dismiss="modal">
                    <span class="fa fa-times"></span>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            $("#EnergyChartSelect_Time").select();
            $("#EnergyChartSelect_Item").select();
            $("#EnergyAreaDateSelect").select();
            $("#EnergyClassSelect").select();

            //时间选择控件
            $.fn.datetimepicker.dates['zh'] = {
                days:       ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六","星期日"],
                daysShort:  ["日", "一", "二", "三", "四", "五", "六","日"],
                daysMin:    ["日", "一", "二", "三", "四", "五", "六","日"],
                months:     ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月","十二月"],
                monthsShort:  ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二"],
                meridiem:    ["上午", "下午"],
                today:       "今天"
            };

            $('#startTime,#endTime').datetimepicker({
                format: 'yyyy-mm-dd hh:ii', // 标签上可用data-date-format="hh:ii" data-link-format="hh:ii"
                autoclose: true, //选择完成自动关闭下拉框
                startView : 2,
                minView:0, //0到分钟结束，1到小时，2到日
                language: 'zh-CN'
            }).on('changeDate',function(ev){
                var dffDate = (new Date($('#endTime').val())).getTime() -  (new Date($('#startTime').val())).getTime()
                if(dffDate <= 0){
                    bootbox.alert('截止时间不能小于开始时间')
                }else{
                    getEnergyHistory()
                }
            });
            //实时数据弹框
            $(".trendsChartItem").on("dblclick",function(){
                $("#realTimeModal").modal('show')
                var Energy = $(this).attr("data-Energy")
                $("#realTimeModal").find(".modal-title").html(Energy+"能数据")
                $("#realTimeModal").find("#EnergyInd").val(Energy)
                $("#startTime").val(myformatter(new Date(new Date().getTime() - 1*24*60*60*1000)))
                $("#endTime").val(myformatter(new Date()))
                getEnergyHistory()
            })
            function getEnergyHistory(){
                $.ajax({
                    url:"/energyHistory",
                    type:"get",
                    data:{
                        StartTime: $("#startTime").val(),
                        EndTime : $("#endTime").val(),
                        Energy : $("#EnergyInd").val(),
                    },
                    success:function (res) {
                        res = JSON.parse(res)
                        $("#EnergyHistoryDataTotal").html(res.total)
                        highchartsEnergyHistoryRender("modalEnergyHistoryChart",res.HistorySeries,res.Unit)
                        highchartsAreaBarRender("rankingChart",res.energyRankX,res.energyRankY,res.Unit)
                    }
                })
            }

            //趋势图表
            ajaxEnergyTrend($("#EnergyChartSelect_Time").val(),$("#EnergyChartSelect_Item").val())
            $('.EnergyChartSelect_Time').bind('DOMNodeInserted',"#EnergyChartSelect_Time",function(e){
                ajaxEnergyTrend(e.target.innerHTML,$("#EnergyChartSelect_Item").val())
            })
            $('.EnergyChartSelect_Item').bind('DOMNodeInserted',"#EnergyChartSelect_Item",function(e){
                ajaxEnergyTrend($("#EnergyChartSelect_Time").val(),e.target.innerHTML)
            })
            function ajaxEnergyTrend(currenttime,classparam){
                $.ajax({
                    url:"/energyTrend",
                    type:"get",
                    data:{
                        currenttime:currenttime,
                        classparam:classparam
                    },
                    success:function(res){
                        res = JSON.parse(res)
                        highchartsRender("highchartsEnergy",res.X,res.Y)
                    }
                })
            }

            //水电气实时数据趋势图
            highchartsRealTimeNoTickRender("ws://192.168.1.106:5003","highcharts-electricity","EtotalZGL","EtotalZGL")
            highchartsRealTimeNoTickRender("ws://192.168.1.106:5004","highcharts-water","WtotalF","WtotalF","WtotalS","WtotalS")
            highchartsRealTimeNoTickRender("ws://192.168.1.106:5005","highcharts-steam","StotalF","StotalF","StotalS","StotalS")

            //区域下拉框
            $.ajax({
                url:"http://127.0.0.1:5000/CUID",
                type:"get",
                data:{
                    tableName: "AreaTable",
                    limit : 100000000,
                    offset : 0
                },
                success:function (res) {
                    res = JSON.parse(res)
                    var option = ''
                    $.each(res.rows,function(i,value){
                        option += `<option value="${ res.rows[i].AreaName }">${ res.rows[i].AreaName }</option>`
                    })
                    $("#EnergyAreaSelect").html(option)
                    $("#EnergyAreaSelect").select();
                }
            })
            //区域能耗量
            EnergyAreaRender($("#EnergyAreaSelect").val(),$("#EnergyAreaDateSelect").val())
            $(".EnergyAreaSelect").bind('DOMNodeInserted',"#EnergyAreaSelect",function(e){
                EnergyAreaRender(e.target.innerHTML,$("#EnergyAreaDateSelect").val())
            })
            $('.EnergyAreaDateSelect').bind('DOMNodeInserted','#EnergyAreaDateSelect',function(e){
                EnergyAreaRender($("#EnergyAreaSelect").val(),e.target.innerHTML)
            })
            function EnergyAreaRender(Area,DateTime,EnergyClass){
                $.ajax({
                    url:"/energyall",
                    type:"get",
                    data:{
                        Area: Area,
                        DateTime : DateTime,
                        EnergyClass : EnergyClass,
                    },
                    success:function (res) {
                        res = JSON.parse(res)
                        $("#ElectricValue").html(res.ElectricValue)
                        $("#WaterValue").html(res.WaterValue)
                        $("#SteamValue").html(res.SteamValue)
                    }
                })
            }
            EnergyCostRender($("#EnergyClassSelect").val())
            $('.EnergyClassSelect').bind('DOMNodeInserted','#EnergyClassSelect',function(e){
                EnergyCostRender(e.target.innerHTML)
            })
            function EnergyCostRender(EnergyClass){
                $.ajax({
                    url:"/energyall",
                    type:"get",
                    data:{
                        EnergyClass : EnergyClass,
                    },
                    success:function (res) {
                        res = JSON.parse(res)
                        $("#costValue").html()
                    }
                })
            }
        })
    </script>
</body>
</html>
