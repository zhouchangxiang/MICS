<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link rel="stylesheet" href="../static/style/bootstrap.min.css">
    <link rel="stylesheet" href="../static/style/bootstrap-table.min.css">
    <link rel="stylesheet" href="../static/style/bootstrap-select.min.css">
    <link rel="stylesheet" href="../static/style/bootstrap-treeview.min.css">
    <link rel="stylesheet" href="../static/style/base.css">
    <script src="../static/script/jquery-3.3.1.min.js"></script>
    <script src="../static/script/bootstrap.min.js"></script>
    <script src="../static/script/bootstrap-table.min.js"></script>
    <script src="../static/script/bootstrap-table-zh-CN.min.js"></script>
    <script src="../static/script/bootstrap-select.min.js"></script>
    <script src="../static/script/bootstrap-treeview.min.js"></script>
    <script src="../static/script/bootbox.min.js"></script>
    <script src="../static/script/base.js"></script>
    <script src="../static/script/bootstrapTableCommon.js"></script>
</head>
<body>
    <div class="wrap">
        <table id="tab"></table>
        <div id="jurisdictionModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">权限管理</h4>
                    </div>
                    <div class="modal-body">
                        <form class="form-horizontal" action="">
                            <div class="form-group">
                                <label for="Name" class="col-sm-3 control-label">用户名</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" name="Name" placeholder="" disabled="disabled">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="WorkNumber" class="col-sm-3 control-label">工号</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" name="WorkNumber" placeholder="" disabled="disabled">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="userName" class="col-sm-3 control-label">权限目录</label>
                                <div class="col-sm-9">
                                    <div id="treeview-checkable" class=""></div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-primary" data-save-btn>更新权限</button></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            $("#tab").tableRender({
                tableName:"User",
                primaryKey:"id",
                toolbarBtnArr:[{
                    domID:"jurisdictionEdit",
                    title:"权限管理"
                }]
            })
            $("#jurisdictionEdit").on("click",function(){
                var tableRows = $("#tab").bootstrapTable("getAllSelections")
                if(tableRows.length == 1){
                    $("#jurisdictionModal").modal('show')
                    $("#jurisdictionModal").find("input[name=Name]").val(tableRows[0].Name)
                    $("#jurisdictionModal").find("input[name=WorkNumber]").val(tableRows[0].WorkNumber)
                    $.ajax({
                        url:"/permission/menulisttree",
                        type:"get",
                        data:{
                            WorkNumber:tableRows[0].WorkNumber
                        },
                        success:function(res){
                            $('#treeview-checkable').treeview({
                                data: res,
                                showIcon: false,
                                showCheckbox: true,
                                onNodeChecked: function(event, node) {
                                    //console.log(node)
                                },
                                onNodeUnchecked: function (event, node) {
                                    //console.log(node)
                                }
                            });
                        }
                    })
                }else{
                    bootbox.alert('请单选一条数据！');
                }
            })
            $("#jurisdictionModal").on("click","[data-save-btn]",function(){
                var nodes = $('#treeview-checkable').treeview("getChecked")
                var tableRows = $("#tab").bootstrapTable("getAllSelections")
                var data = []
                $.each(nodes,function(i,value){
                    var checkedNodes = {}
                    checkedNodes.Name = tableRows[0].Name
                    checkedNodes.WorkNumber = tableRows[0].WorkNumber
                    checkedNodes.MenuName = nodes[i].text
                    checkedNodes.MenuType = nodes[i].MenuType
                    checkedNodes.ModulMenuCode = nodes[i].ModulMenuCode
                    data.push(checkedNodes)
                })
                data = JSON.stringify(data)
                $.ajax({
                    url:"/permission/PermissionsSave",
                    type:"post",
                    data:{data:data},
                    success:function(res){
                        if(res == "OK"){
                            $("#jurisdictionModal").modal('hide')
                            var dialog = bootbox.dialog({
                                message: '<p class="text-center mb-0"><i class="fa fa-spin fa-cog"></i>操作成功！</p>',
                                closeButton: false
                            });
                            dialog.init(function(){
                                setTimeout(function(){
                                    dialog.modal('hide');
                                }, 2000);
                            });
                            $("#tab").bootstrapTable('refresh');
                        } else {
                            bootbox.alert(data)
                        }
                    }
                })
            })
        })
    </script>
</body>
</html>